<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title> 3D Building Solar Analysis</title>
    <!-- 최신 버전의 Cesium 사용 -->
    <script src="https://cdn.jsdelivr.net/npm/cesium@1.120/Build/Cesium/Cesium.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/cesium@1.120/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body, #cesiumContainer {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
        #toolbar {
            position: absolute; top: 10px; left: 10px; background: rgba(42, 42, 42, 0.8);
            padding: 10px; border-radius: 4px; color: white; font-family: sans-serif;
            z-index: 1000;
        }
        .cesium-infoBox {
            max-width: 320px !important;
            width: 320px !important;
        }
        .cesium-infoBox-description {
            max-width: 300px !important;
        }
        #error-msg {
            color: #ff6b6b;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div id="toolbar">
        <h4>3D 벽면 일사량 분석 (Cesium)</h4>
        <div id="info">데이터 로딩 중...</div>
        <div id="error-msg"></div>
    </div>

    <script>
    // Cesium 로드 확인
    if (typeof Cesium === 'undefined') {
        document.getElementById('error-msg').innerText = 'Cesium 라이브러리 로드 실패. 페이지를 새로고침해주세요.';
        throw new Error('Cesium is not loaded');
    }

    // Cesium Ion 토큰 설정
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIxZTBiMzA2OS04ZTMxLTQ1NjMtYjU5OC1lMWVlMWViZmI1MjgiLCJpZCI6MzA1NywiaWF0IjoxNzY5NTc0NzY3fQ.2t_Z8vHd3k6LbTHlxTZj76HiAHsCvsxms1lkM80nOB4';

    // Cesium Viewer 초기화
    const viewer = new Cesium.Viewer('cesiumContainer', {
        imageryProvider: false,
        baseLayerPicker: false,
        sceneModePicker: true,
        navigationHelpButton: false,
        homeButton: false,
        infoBox: true,
        selectionIndicator: true,
        shadows: true
    });

    // Earth at Night 이미지 레이어 추가
    (async () => {
        try {
            const imageryProvider = await Cesium.IonImageryProvider.fromAssetId(3812);
            viewer.imageryLayers.addImageryProvider(imageryProvider);
        } catch (e) {
            console.warn('Imagery provider load failed:', e);
        }
    })();

    // GeoJSON을 CZML로 변환
    function convertGeoJsonToCzml(geoJson) {
        const czml = [
            {
                "id": "document",
                "name": "SolarAnalysis",
                "version": "1.0"
            }
        ];

        geoJson.features.forEach((feature, index) => {
            const props = feature.properties;
            const coords = feature.geometry.coordinates[0];
            
            const positions = [];
            coords.forEach(coord => {
                positions.push(coord[0], coord[1], coord[2]);
            });

            const color = props.fill_color || [255, 255, 255, 255];

            const azimuth = Math.round(props.azimuth || 0);
            const area = Math.round(props.area_m2 || 0);
            const annualRadIntensity = Math.round(props.annual_rad_intensity || 0);
            const annualPvYield = Math.round(props.annual_pv_yield_kWh || 0);

            const packet = {
                "id": "face_" + index,
                "name": props.type + " (Bld: " + props.bld_id + ")",
                "polygon": {
                    "positions": {
                        "cartographicDegrees": positions
                    },
                    "material": {
                        "solidColor": {
                            "color": {
                                "rgba": color
                            }
                        }
                    },
                    "perPositionHeight": true,
                    "outline": true,
                    "outlineColor": { "rgba": [255, 255, 255, 50] }
                },
                "description": `
                    <b>유형:</b> ${props.type}<br/>
                    <b>방위각:</b> ${azimuth}°<br/>
                    <b>면적:</b> ${area.toLocaleString()} m²<br/>     
                    <b>연간 일사량(강도):</b> ${annualRadIntensity.toLocaleString()} Wh/m²<br/>
                    <b>연간 일사량(이량):</b> ${annualPvYield.toLocaleString()} kWh
                `
            };
            czml.push(packet);
        });

        return czml;
    }

    // 데이터 로드 및 표출
    async function loadSolarData() {
        try {
            document.getElementById('info').innerText = 'GeoJSON 파일 로딩 중...';
            
            // GeoJSON 파일 읽기
            const response = await fetch('3D_pv_yield.geojson');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            document.getElementById('info').innerText = 'CZML 변환 중...';
            
            // CZML로 변환
            const czmlData = convertGeoJsonToCzml(data);

            document.getElementById('info').innerText = 'Cesium에 데이터 추가 중...';
            
            // 데이터 소스 추가
            const dataSource = await Cesium.CzmlDataSource.load(czmlData);
            await viewer.dataSources.add(dataSource);

            // 카메라를 데이터 위치로 이동
            viewer.zoomTo(dataSource);
            
            document.getElementById('info').innerText = `총 ${data.features.length}개의 면(Face) 로드 완료`;

        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('error-msg').innerText = `오류: ${error.message}`;
            document.getElementById('info').innerText = '데이터 로드 실패';
        }
    }

    // 씬 설정
    viewer.scene.globe.depthTestAgainstTerrain = true;
    viewer.scene.globe.enableLighting = true;

    // 데이터 로드 실행
    loadSolarData();
    </script>
</body>
</html>
