<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>3DGS Viewer</title>
	<script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>	
    <script src="https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.css" rel="stylesheet" />
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
            "gaussian-splats-3d": "https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.3.3/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Pretendard', -apple-system, sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        #controls {
            position: absolute; top: 20px; left: 20px; background: white;
            padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 10; width: 300px;
        }
        #controls h3 { margin: 0 0 15px 0; font-size: 18px; color: #333; }
        
        select, .btn-load { 
            width: 100%; padding: 12px; border-radius: 8px; 
            border: 1px solid #ddd; margin-top: 10px; 
            font-weight: 600; cursor: pointer; font-size: 14px;
        }
        .btn-load { 
            background: #28a745; color: white; border: none; 
            transition: background 0.2s;
        }
        .btn-load:hover { background: #218838; }
        
        /* 3DGS ë·°ì–´ íŒì—… */
        #gs-popup {
            display: none; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 85vw; height: 80vh;
            background: #000; border-radius: 20px; z-index: 100; 
            border: 1px solid #444; box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }
        #gs-container { width: 100%; height: 100%; border-radius: 20px; }
        
        #close-btn { 
            position: absolute; top: 15px; right: 15px; 
            background: #ff4444; color: white; border: none; 
            border-radius: 50%; width: 40px; height: 40px; 
            cursor: pointer; z-index: 101; font-size: 20px; 
            font-weight: bold; transition: background 0.2s;
        }
        #close-btn:hover { background: #cc0000; }
        
        #loading-text { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); color: white; 
            font-size: 16px; display: none; 
        }
        
        /* ë§ˆì»¤ ì •ë³´ í‘œì‹œ */
        .maplibregl-popup-content {
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .maplibregl-popup-content h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: #333;
        }
        .maplibregl-popup-content button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
        }
        .maplibregl-popup-content button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div id="controls">
    <h4> ğŸŒ ë§ˆì»¤ ì•„ì´ì½˜ì„ í´ë¦­í•˜ë©´ 3DGSê°€ ë³´ì…ë‹ˆë‹¤. </h4>

    <select id="mapStyleSelect">
        <option value="carto-light">ğŸ—ºï¸ Carto Light</option>
        <option value="osm">ğŸ—ºï¸ Standard OSM</option>
        <option value="carto-dark">ğŸ—ºï¸ Carto Dark</option>
    </select>
    
    <p style="font-size: 12px; color: #666; margin-top: 15px; line-height: 1.5;">
        ğŸ’¡ ìƒˆë¡œìš´ 3DGSë¥¼ ì˜¬ë¦¬ê³  ì‹¶ì€ ê²½ìš° ì§€ë„ë¥¼ í™•ëŒ€ ì´ë™í•˜ê³  ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
    </p>
    <input type="file" id="file-input" accept=".splat" style="display: none;">
    <button class="btn-load" onclick="document.getElementById('file-input').click()">
        ğŸ“‚ .SPLAT íŒŒì¼ ì—´ê¸°
    </button>
    
</div>

<div id="gs-popup">
    <button id="close-btn">&times;</button>
    <div id="loading-text">ë°ì´í„° í•´ì„ ì¤‘...</div>
    <div id="gs-container"></div>
</div>

<script type="module">
    import * as THREE from 'three';
    import * as GaussianSplats3D from 'gaussian-splats-3d';

    // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ë¶€ ë²„ê·¸ ìˆ˜ì •ì„ ìœ„í•œ Polyfill
    if (GaussianSplats3D.AbortablePromise && !GaussianSplats3D.AbortablePromise.reject) {
        GaussianSplats3D.AbortablePromise.reject = (reason) => 
            new GaussianSplats3D.AbortablePromise((_, reject) => reject(reason));
    }

    // ìƒ˜í”Œ ë°ì´í„° (ì‹¤ì œ ì‘ë™í•˜ëŠ” .splat íŒŒì¼)
    const sampleData = [
        { 
            name: 'ì •ì› (Garden)', 
            loc: [132.4535, 34.3954], 
            url: 'https://huggingface.co/datasets/dylanebert/3dgs/resolve/main/garden/garden-7k.splat',
            color: '#ff4444',
            description: 'ì •ì› 3D ìŠ¤ìº” ë°ì´í„°'
        },
        { 
            name: 'ìì „ê±° (Bicycle)', 
            loc: [132.455, 34.397], 
            url: 'https://huggingface.co/datasets/dylanebert/3dgs/blob/main/bicycle/bicycle-7k-mini.splat',
            color: '#007bff',
            description: 'ìì „ê±° 3D ìŠ¤ìº” ë°ì´í„°'
        }
    ];

    // ì§€ë„ ìŠ¤íƒ€ì¼
    const mapStyles = {
        "osm": "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
        "carto-light": "https://basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        "carto-dark": "https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
    };

    // ì§€ë„ ì´ˆê¸°í™”
    const map = new maplibregl.Map({
        container: 'map',
        style: createMapStyle('carto-light'),
        center: [132.4535, 34.3954],
        zoom: 16,
        pitch: 45
    });

    function createMapStyle(styleKey) {
        return {
            "version": 8,
            "sources": {
                "raster": {
                    "type": "raster",
                    "tiles": [mapStyles[styleKey]],
                    "tileSize": 256
                }
            },
            "layers": [{
                "id": "base",
                "type": "raster",
                "source": "raster"
            }]
        };
    }

    // ì§€ë„ ìŠ¤íƒ€ì¼ ë³€ê²½
    document.getElementById('mapStyleSelect').addEventListener('change', (e) => {
        map.setStyle(createMapStyle(e.target.value));
        
        // ìŠ¤íƒ€ì¼ ë¡œë“œ í›„ ë§ˆì»¤ ì¬ìƒì„±
        map.once('styledata', () => {
            markers.forEach(m => m.remove());
            markers = [];
            sampleData.forEach(s => addMarker(s));
        });
    });

    let viewer = null;
    let markers = [];

    // ìƒ˜í”Œ ë§ˆì»¤ ì¶”ê°€
    sampleData.forEach(sample => addMarker(sample));

    function addMarker(data) {
        const el = document.createElement('div');
        el.style.width = '30px';
        el.style.height = '30px';
        el.style.borderRadius = '50%';
        el.style.backgroundColor = data.color;
        el.style.border = '3px solid white';
        el.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
        el.style.cursor = 'pointer';
        
        const marker = new maplibregl.Marker({ element: el })
            .setLngLat(data.loc)
            .addTo(map);
        
        // íŒì—… ìƒì„±
        const popup = new maplibregl.Popup({ 
            offset: 25,
            closeButton: false 
        }).setHTML(`
            <h4>${data.name}</h4>
            <p style="margin: 8px 0; font-size: 13px; color: #666;">${data.description || ''}</p>
            <button onclick="window.openViewer('${data.url}', '${data.name}')">
                ğŸ¯ 3D ë·°ì–´ ì—´ê¸°
            </button>
        `);
        
        marker.setPopup(popup);
        markers.push(marker);
        
        // í´ë¦­ ì‹œ ë·°ì–´ ì—´ê¸°
        el.addEventListener('click', () => {
            openViewer(data.url, data.name);
        });
    }

    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    document.getElementById('file-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Data URLë¡œ ë³€í™˜
        const reader = new FileReader();
        const dataUrl = await new Promise((resolve, reject) => {
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        // í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ì— ë§ˆì»¤ ì¶”ê°€
        const center = map.getCenter();
        const newData = {
            name: file.name.replace('.splat', ''),
            loc: [center.lng, center.lat],
            url: dataUrl,
            color: '#28a745',
            description: 'ì—…ë¡œë“œëœ ë¡œì»¬ íŒŒì¼'
        };
        
        addMarker(newData);
        
        // í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™ ë° ë·°ì–´ ì—´ê¸°
        map.flyTo({ 
            center: [center.lng, center.lat], 
            zoom: 16,
            duration: 1000
        });
        
        setTimeout(() => {
            openViewer(dataUrl, newData.name);
        }, 1000);
    });

    // 3DGS ë·°ì–´ ì—´ê¸°
    window.openViewer = openViewer;
    
    async function openViewer(url, name) {
        const popup = document.getElementById('gs-popup');
        const loadingText = document.getElementById('loading-text');
        const container = document.getElementById('gs-container');
        
        popup.style.display = 'block';
        loadingText.style.display = 'block';
        loadingText.textContent = `"${name}" ë¡œë”© ì¤‘...`;
        
        try {
            // ê¸°ì¡´ ë·°ì–´ ì •ë¦¬
            if (viewer) {
                viewer.dispose();
                container.innerHTML = '';
            }

            // ìƒˆ ë·°ì–´ ìƒì„±
            viewer = new GaussianSplats3D.Viewer({
                'rootElement': container,
                'useBuiltInControls': true,
                'selfDriven': false,
                'camera': {
                    'up': [0, -1, 0]  // ì¹´ë©”ë¼ ì—… ë²¡í„° ì¡°ì •
                },
                'initialCameraPosition': [0, 1, 5],
                'initialCameraLookAt': [0, 0, 0]
            });

            // .splat íŒŒì¼ ë¡œë“œ
            await viewer.addSplatScene(url, {
                'format': GaussianSplats3D.SceneFormat.Splat,
                'splatAlphaRemovalThreshold': 5,
                'showLoadingUI': false,
                'progressiveLoad': false,
                'rotation': [0, 0, 0, 1],  // ì¿¼í„°ë‹ˆì–¸ (íšŒì „ ì—†ìŒ)
                'position': [0, 0, 0],
                'scale': [1, 1, 1]
            });

            loadingText.style.display = 'none';
            viewer.start();

        } catch (err) {
            console.error("Critical Load Error:", err);
            loadingText.textContent = "ë¡œë”© ì‹¤íŒ¨: " + err.message;
            setTimeout(() => {
                popup.style.display = 'none';
            }, 3000);
        }
    }

    // ë·°ì–´ ë‹«ê¸°
    document.getElementById('close-btn').addEventListener('click', () => {
        document.getElementById('gs-popup').style.display = 'none';
        if (viewer) {
            viewer.stop();
        }
    });

    // ESC í‚¤ë¡œ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.getElementById('gs-popup').style.display === 'block') {
            document.getElementById('close-btn').click();
        }
    });
</script>
</body>
</html>
