<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 3DGS Viewer</title>
    <script src="https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.1.3/dist/maplibre-gl.css" rel="stylesheet" />
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/",
            "gaussian-splats-3d": "https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.3.3/build/gaussian-splats-3d.module.js"
        }
    }
    </script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Pretendard', -apple-system, sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        #controls {
            position: absolute; top: 20px; left: 20px; background: white;
            padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 10; width: 300px;
        }
        #controls h3 { margin: 0 0 15px 0; font-size: 18px; color: #333; }
        
        select, .btn-load { 
            width: 100%; padding: 12px; border-radius: 8px; 
            border: 1px solid #ddd; margin-top: 10px; 
            font-weight: 600; cursor: pointer; font-size: 14px;
        }
        .btn-load { 
            background: #28a745; color: white; border: none; 
            transition: background 0.2s;
        }
        .btn-load:hover { background: #218838; }
        
        /* 3DGS ë·°ì–´ íŒì—… */
        #gs-popup {
            display: none; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 85vw; height: 80vh;
            background: #000; border-radius: 20px; z-index: 100; 
            border: 1px solid #444; box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }
        #gs-container { width: 100%; height: 100%; border-radius: 20px; }
        
        #close-btn { 
            position: absolute; top: 15px; right: 15px; 
            background: #ff4444; color: white; border: none; 
            border-radius: 50%; width: 40px; height: 40px; 
            cursor: pointer; z-index: 101; font-size: 20px; 
            font-weight: bold; transition: background 0.2s;
        }
        #close-btn:hover { background: #cc0000; }
        
        #loading-text { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); color: white; 
            font-size: 16px; display: none; z-index: 102;
            background: rgba(0,0,0,0.8); padding: 20px;
            border-radius: 10px; max-width: 80%;
            text-align: center;
        }
        
        /* ê²½ê³  ë©”ì‹œì§€ */
        #warning {
            display: none;
            position: absolute; top: 20px; right: 20px;
            background: #ff9800; color: white; padding: 15px;
            border-radius: 8px; max-width: 300px; z-index: 11;
            font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        /* í¬ë§· ë±ƒì§€ */
        .format-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }
        .format-ply { background: #2196F3; color: white; }
        .format-splat { background: #4CAF50; color: white; }
        .format-spz { background: #FF9800; color: white; }
        
        /* ë§ˆì»¤ ì •ë³´ í‘œì‹œ */
        .maplibregl-popup-content {
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .maplibregl-popup-content h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: #333;
        }
        .maplibregl-popup-content button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
        }
        .maplibregl-popup-content button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div id="controls">
    <h4>ğŸŒ ë§ˆì»¤ ì•„ì´ì½˜ì„ í´ë¦­í•˜ë©´ 3DGSê°€ ë³´ì…ë‹ˆë‹¤.</h4>

    <select id="mapStyleSelect">
        <option value="carto-light">ğŸ—ºï¸ Carto Light</option>
        <option value="osm">ğŸ—ºï¸ Standard OSM</option>
        <option value="carto-dark">ğŸ—ºï¸ Carto Dark</option>
    </select>
    
    <p style="font-size: 12px; color: #666; margin-top: 15px; line-height: 1.5;">
        ğŸ’¡ ìƒˆë¡œìš´ 3DGSë¥¼ ì˜¬ë¦¬ê³  ì‹¶ì€ ê²½ìš° ì§€ë„ë¥¼ í™•ëŒ€ ì´ë™í•˜ê³  ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
    </p>
    <input type="file" id="file-input" accept=".splat,.ply,.spz" style="display: none;">
    <button class="btn-load" onclick="document.getElementById('file-input').click()">
        ğŸ“‚ 3DGS íŒŒì¼ ì—´ê¸° (.ply/.splat)
    </button>
</div>

<div id="warning">
    âš ï¸ SharedArrayBufferë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
</div>

<div id="gs-popup">
    <button id="close-btn">&times;</button>
    <div id="loading-text">ë°ì´í„° í•´ì„ ì¤‘...</div>
    <div id="gs-container"></div>
</div>

<script type="module">
    import * as THREE from 'three';
    import * as GaussianSplats3D from 'gaussian-splats-3d';

    // SharedArrayBuffer ì²´í¬
    const hasSharedArrayBuffer = typeof SharedArrayBuffer !== 'undefined';
    if (!hasSharedArrayBuffer || !crossOriginIsolated) {
        console.warn('SharedArrayBuffer not available. Some features may be limited.');
        document.getElementById('warning').style.display = 'block';
        setTimeout(() => {
            document.getElementById('warning').style.display = 'none';
        }, 5000);
    }

    // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ë¶€ ë²„ê·¸ ìˆ˜ì •ì„ ìœ„í•œ Polyfill
    if (GaussianSplats3D.AbortablePromise && !GaussianSplats3D.AbortablePromise.reject) {
        GaussianSplats3D.AbortablePromise.reject = (reason) => 
            new GaussianSplats3D.AbortablePromise((_, reject) => reject(reason));
    }

    // ìƒ˜í”Œ ë°ì´í„° (ë‹¤ì–‘í•œ í¬ë§·)
    const sampleData = [
        { 
            name: 'ì •ì› (Garden)', 
            loc: [132.4535, 34.3954], 
            url: 'https://huggingface.co/datasets/dylanebert/3dgs/resolve/main/garden/garden-7k.splat',
            color: '#4CAF50',
            description: 'ì •ì› 3D ìŠ¤ìº” ë°ì´í„°',
            format: 'splat'
        },
        { 
            name: 'ìì „ê±° (Bicycle)', 
            loc: [132.455, 34.397], 
            url: 'https://huggingface.co/datasets/dylanebert/3dgs/resolve/main/bicycle/bicycle-7k.splat',
            color: '#007bff',
            description: 'ìì „ê±° 3D ìŠ¤ìº” ë°ì´í„°',
            format: 'splat'
        }
    ];

    // ì§€ë„ ìŠ¤íƒ€ì¼
    const mapStyles = {
        "osm": "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
        "carto-light": "https://basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        "carto-dark": "https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
    };

    // ì§€ë„ ì´ˆê¸°í™”
    const map = new maplibregl.Map({
        container: 'map',
        style: createMapStyle('carto-light'),
        center: [132.4535, 34.3954],
        zoom: 16,
        pitch: 45
    });

    function createMapStyle(styleKey) {
        return {
            "version": 8,
            "sources": {
                "raster": {
                    "type": "raster",
                    "tiles": [mapStyles[styleKey]],
                    "tileSize": 256
                }
            },
            "layers": [{
                "id": "base",
                "type": "raster",
                "source": "raster"
            }]
        };
    }

    // ì§€ë„ ìŠ¤íƒ€ì¼ ë³€ê²½
    document.getElementById('mapStyleSelect').addEventListener('change', (e) => {
        map.setStyle(createMapStyle(e.target.value));
        
        // ìŠ¤íƒ€ì¼ ë¡œë“œ í›„ ë§ˆì»¤ ì¬ìƒì„±
        map.once('styledata', () => {
            markers.forEach(m => m.remove());
            markers = [];
            sampleData.forEach(s => addMarker(s));
        });
    });

    let viewer = null;
    let markers = [];

    // ìƒ˜í”Œ ë§ˆì»¤ ì¶”ê°€
    sampleData.forEach(sample => addMarker(sample));

    function addMarker(data) {
        const el = document.createElement('div');
        el.style.width = '30px';
        el.style.height = '30px';
        el.style.borderRadius = '50%';
        el.style.backgroundColor = data.color;
        el.style.border = '3px solid white';
        el.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
        el.style.cursor = 'pointer';
        
        const marker = new maplibregl.Marker({ element: el })
            .setLngLat(data.loc)
            .addTo(map);
        
        // í¬ë§· ë±ƒì§€
        const formatClass = `format-${data.format}`;
        const formatBadge = `<span class="format-badge ${formatClass}">.${data.format.toUpperCase()}</span>`;
        
        // íŒì—… ìƒì„±
        const popup = new maplibregl.Popup({ 
            offset: 25,
            closeButton: false 
        }).setHTML(`
            <h4>${data.name} ${formatBadge}</h4>
            <p style="margin: 8px 0; font-size: 13px; color: #666;">${data.description || ''}</p>
            <button onclick="window.openViewer('${data.url || ''}', '${data.name}', '${data.format}', null, '${markers.length}')">
                ğŸ¯ 3D ë·°ì–´ ì—´ê¸°
            </button>
        `);
        
        marker.setPopup(popup);
        markers.push(marker);
        
        // í´ë¦­ ì‹œ ë·°ì–´ ì—´ê¸°
        el.addEventListener('click', () => {
            openViewer(data.url || null, data.name, data.format, data.buffer || null);
        });
    }

    // íŒŒì¼ í™•ì¥ìë¡œ í¬ë§· ê°ì§€
    function detectFormat(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        if (ext === 'ply') return 'ply';
        if (ext === 'spz') return 'spz';
        if (ext === 'splat') return 'splat';
        return 'splat'; // ê¸°ë³¸ê°’
    }

    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    document.getElementById('file-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const format = detectFormat(file.name);
        
        // ëª¨ë“  í¬ë§·ì„ ArrayBufferë¡œ ì½ê¸°
        const arrayBuffer = await file.arrayBuffer();

        // í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ì— ë§ˆì»¤ ì¶”ê°€
        const center = map.getCenter();
        const colorMap = {
            'ply': '#2196F3',
            'splat': '#4CAF50',
            'spz': '#FF9800'
        };
        
        const newData = {
            name: file.name.replace(/\.(ply|splat|spz)$/, ''),
            loc: [center.lng, center.lat],
            buffer: arrayBuffer,  // ArrayBuffer ì €ì¥
            color: colorMap[format],
            description: `ì—…ë¡œë“œëœ ${format.toUpperCase()} íŒŒì¼`,
            format: format
        };
        
        addMarker(newData);
        
        // í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™ ë° ë·°ì–´ ì—´ê¸°
        map.flyTo({ 
            center: [center.lng, center.lat], 
            zoom: 16,
            duration: 1000
        });
        
        setTimeout(() => {
            openViewer(null, newData.name, format, arrayBuffer);
        }, 1000);
    });

    // 3DGS ë·°ì–´ ì—´ê¸°
    window.openViewer = openViewer;
    
    async function openViewer(url, name, format, arrayBuffer = null) {
        const popup = document.getElementById('gs-popup');
        const loadingText = document.getElementById('loading-text');
        const container = document.getElementById('gs-container');
        
        popup.style.display = 'block';
        loadingText.style.display = 'block';
        
        const formatUpper = format.toUpperCase();
        loadingText.innerHTML = `
            <div>"${name}"</div>
            <div style="font-size: 14px; margin-top: 10px; opacity: 0.8;">
                <span class="format-badge format-${format}">.${formatUpper}</span> íŒŒì¼ ë¡œë”© ì¤‘...
            </div>
        `;
        
        try {
            // ê¸°ì¡´ ë·°ì–´ ì •ë¦¬
            if (viewer) {
                try {
                    viewer.dispose();
                } catch (e) {
                    console.warn('Viewer dispose error:', e);
                }
            }
            
            // ì»¨í…Œì´ë„ˆ ì™„ì „ ì´ˆê¸°í™”
            container.innerHTML = '';
            
            // DOM ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            await new Promise(resolve => setTimeout(resolve, 100));

            // ìƒˆ ë·°ì–´ ìƒì„±
            const viewerOptions = {
                rootElement: container,
                useBuiltInControls: true,
                selfDriven: false,
                sharedMemoryForWorkers: false,
                gpuAcceleratedSort: false,
                loadingSpinner: null  // ëª¨ë“  í¬ë§·ì—ì„œ ë¹„í™œì„±í™”
            };
            
            viewer = new GaussianSplats3D.Viewer(viewerOptions);

            // í¬ë§·ì— ë”°ë¥¸ ë¡œë“œ ì˜µì…˜ ì„¤ì •
            let sceneFormat;
            let loadOptions = {
                splatAlphaRemovalThreshold: 5,
                showLoadingUI: false,
                progressiveLoad: false
            };

            switch(format) {
                case 'ply':
                    sceneFormat = GaussianSplats3D.SceneFormat.Ply;
                    loadingText.innerHTML += '<div style="font-size: 12px; margin-top: 5px;">PLY íŒŒì¼ íŒŒì‹± ì¤‘... (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)</div>';
                    break;
                case 'spz':
                    sceneFormat = GaussianSplats3D.SceneFormat.SPZ;
                    loadingText.innerHTML += '<div style="font-size: 12px; margin-top: 5px;">ì••ì¶• íŒŒì¼ ì••ì¶• í•´ì œ ì¤‘...</div>';
                    break;
                case 'splat':
                default:
                    sceneFormat = GaussianSplats3D.SceneFormat.Splat;
                    break;
            }

            loadOptions.format = sceneFormat;

            // URL ë˜ëŠ” ArrayBufferë¡œ íŒŒì¼ ë¡œë“œ
            if (arrayBuffer) {
                // ArrayBufferë¥¼ Blobìœ¼ë¡œ ë³€í™˜ í›„ Blob URL ìƒì„±
                const blob = new Blob([arrayBuffer], { type: 'application/octet-stream' });
                const blobUrl = URL.createObjectURL(blob);
                
                try {
                    await viewer.addSplatScene(blobUrl, loadOptions);
                    // ë¡œë“œ ì™„ë£Œ í›„ Blob URL ì •ë¦¬
                    setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
                } catch (err) {
                    URL.revokeObjectURL(blobUrl);
                    throw err;
                }
            } else if (url) {
                // ì™¸ë¶€ URL ì‚¬ìš©
                await viewer.addSplatScene(url, loadOptions);
            } else {
                throw new Error('URL ë˜ëŠ” ArrayBufferê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            }

            loadingText.style.display = 'none';
            viewer.start();

        } catch (err) {
            console.error("Critical Load Error:", err);
            loadingText.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 10px;">âŒ</div>
                    <div>ë¡œë”© ì‹¤íŒ¨</div>
                    <div style="font-size: 12px; margin-top: 10px; opacity: 0.8;">${err.message}</div>
                    <div style="font-size: 11px; margin-top: 10px; opacity: 0.6;">
                        ${format.toUpperCase()} íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ í˜¸í™˜ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                    <div style="font-size: 11px; margin-top: 5px; opacity: 0.6;">
                        NGINX ì„œë²„ì˜ COOP/COEP í—¤ë” ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.
                    </div>
                </div>
            `;
        }
    }

    // ë·°ì–´ ë‹«ê¸°
    document.getElementById('close-btn').addEventListener('click', () => {
        document.getElementById('gs-popup').style.display = 'none';
        if (viewer) {
            try {
                viewer.stop();
            } catch (e) {
                console.warn('Viewer stop error:', e);
            }
        }
    });

    // ESC í‚¤ë¡œ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.getElementById('gs-popup').style.display === 'block') {
            document.getElementById('close-btn').click();
        }
    });
</script>
</body>
</html>
